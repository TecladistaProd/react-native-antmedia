"use strict";var e=require("react"),n=require("react-native-webrtc");function t(){return(t=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}const r=function(){function e(){}return e.prototype.then=function(n,t){const r=new e,a=this.s;if(a){const e=1&a?n:t;if(e){try{o(r,1,e(this.v))}catch(e){o(r,2,e)}return r}return this}return this.o=function(e){try{const a=e.v;1&e.s?o(r,1,n?n(a):a):t?o(r,1,t(a)):o(r,2,a)}catch(e){o(r,2,e)}},r},e}();function o(e,n,t){if(!e.s){if(t instanceof r){if(!t.s)return void(t.o=o.bind(null,e,n));1&n&&(n=t.s),t=t.v}if(t&&t.then)return void t.then(o.bind(null,e,n),o.bind(null,e,2));e.s=n,e.v=t;const a=e.o;a&&a(e)}}function a(e){return e instanceof r&&1&e.s}function c(e,n){try{var t=e()}catch(e){return n(e)}return t&&t.then?t.then(void 0,n):t}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),exports.useAntMedia=function(i){var s=i.url,u=i.onopen,l=i.callbackError,d=i.callback,f=i.mediaConstraints,m=i.sdp_constraints,h=i.peerconnection_config,v=i.bandwidth,b=i.debug,p=i.onlyDataChannel,g=e.useState("")[1],k=e.useState(!1),y=k[0],C=k[1],S=e.useState(!1),I=S[0],P=S[1],w=e.useState(!1),R=w[0],j=w[1],J=e.useState({}),L=J[0],O=J[1],T=e.useState(!1),E=T[0],M=T[1],D=e.useRef(null),U=e.useRef({ws:null}).current,_=e.useRef([]).current,x=e.useRef({}).current,A=e.useRef({}).current,N=e.useRef({}).current,V=e.useRef({}).current,F=e.useRef({value:v||900}).current,q=e.useRef(null),B=e.useCallback((function(e){if(null!=x[e]&&(null!=x[e].dataChannel&&x[e].dataChannel.close(),O((function(n){var r=t({},n);return[].concat(x[e].getLocalStreams()).forEach((function(e){var n;(null==(n=D.current)?void 0:n.toURL())!==e.toURL()&&delete r[e.toURL()]})),r})),"closed"!==x[e].signalingState)){x[e].close(),x[e]=null,delete x[e];var n=_.indexOf(e);-1!==n&&_.splice(n,1)}null!=A[e]&&(clearInterval(A[e].timerId),delete A[e])}),[]),W=e.useCallback((function(e){var n=null,r=[],o=x[e].getRemoteStreams();O((function(n){var r=t({},n);return[].concat(x[e].getLocalStreams(),x[e].getRemoteStreams()).forEach((function(e){var n;(null==(n=D.current)?void 0:n.toURL())!==e.toURL()&&(r[e.toURL()]=e)})),r})),o.forEach((function(e){e.getTracks().forEach((function(e){r.push({track:e,getParameters:function(){return{}},setParameters:function(){return{}}})}))}));for(var a=0;a<r.length;a++)if(null!=r[a].track&&"video"===r[a].track.kind){n=r[a];break}return n}),[]),z=e.useCallback((function(e,n){try{var t=W(n);if(null!==t){var r=t.getParameters();return r.encodings||(r.encodings=[{}]),"unlimited"===e?delete r.encodings[0].maxBitrate:r.encodings[0].maxBitrate=1e3*parseInt(e+"",10),Promise.resolve(t.setParameters(r))}throw new Error("Video sender not found to change bandwidth")}catch(e){return Promise.reject(e)}}),[]),G=e.useCallback((function(e,n){e.candidate&&U.ws&&U.ws.sendJson({command:"takeCandidate",streamId:n,label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate})}),[]),H=e.useCallback((function(e,n){L[n]||q.current&&d.call(q.current,"newStreamAvailable",{track:e.streams[0],streamId:n})}),[]),K=e.useCallback((function(e,r){try{if(null==x[e]){var o=e;x[e]=new n.RTCPeerConnection(h||{iceServers:[]}),N[e]=!1,V[e]=[],!_.includes(e)&&D.current&&x[e].addStream(D.current);try{if(x[e].onicecandidate=function(e){G(e,o)},x[e].ontrack=function(e){b&&console.log("onTrack",e),H(e,o)},x[e].onaddstream=function(n){O((function(n){var r=t({},n);return[].concat(x[e].getLocalStreams(),x[e].getRemoteStreams()).forEach((function(e){var n;(null==(n=D.current)?void 0:n.toURL())!==e.toURL()&&(r[e.toURL()]=e)})),r}))},"publish"===r){var a=x[e].createDataChannel(e,{ordered:!0});Q(e,a)}else if("play"===r)x[e].ondatachannel=function(n){Q(e,n.channel)};else{var i=x[e].createDataChannel(e,{ordered:!0});Q(e,i),x[e].ondatachannel=function(n){Q(e,n.channel)}}R||(x[e].oniceconnectionstatechange=function(n){if(!n.target.iceConnectionState.match(/(closed|disconnected|failed)/i))try{W(e)}catch(e){}"connected"===n.target.iceConnectionState&&function(){try{var n=c((function(){return Promise.resolve(z(F.value,e)).then((function(){}))}),(function(e){b&&console.error(e)}));n&&n.then&&n.then((function(){}))}catch(e){Promise.reject(e)}}()})}catch(e){b&&console.error("initPeerConnectionError",e.message)}}return Promise.resolve()}catch(e){return Promise.reject(e)}}),[R,D]),Q=e.useCallback((function(e,n){console.log(e,n),n.onerror=function(t){"closed"!==n.readyState&&l&&l("data_channel_error",{streamId:e,error:t})},n.onmessage=function(n){d&&q.current&&d.call(q.current,"data_received",{streamId:e,event:n})},n.onopen=function(){x[e].dataChannel=n,d&&q.current&&d.call(q.current,"data_channel_opened",e)},n.onclose=function(){d&&q.current&&d.call(q.current,"data_channel_closed",e)}}),[]),X=e.useCallback((function(e,n){try{var t=c((function(){return Promise.resolve(x[n].setLocalDescription(e)).then((function(){U.ws&&U.ws.sendJson({command:"takeConfiguration",streamId:n,type:e.type,sdp:e.sdp})}))}),(function(e){b&&console.log("gotDescriptionError",e)}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}),[]),Y=e.useCallback((function(e){try{var n=c((function(){return Promise.resolve(K(e,"publish")).then((function(){return Promise.resolve(x[e].createOffer(m)).then((function(n){return Promise.resolve(X(n,e)).then((function(){}))}))}))}),(function(e){b&&console.log("startPublishing error",e.message,e.stack)}));return Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}),[K]),Z=e.useCallback((function(e){try{return Promise.resolve(n.mediaDevices.getUserMedia(e)).then((function(e){"boolean"!=typeof e&&(D.current=e)}))}catch(e){return Promise.reject(e)}}),[]),$=e.useCallback((function(e,n,t,r){var o={};if(p)o={command:"publish",streamId:e,token:n,subscriberId:void 0!==typeof t?t:"",subscriberCode:void 0!==typeof r?r:"",video:!1,audio:!1};else{if(D.current)return;var a=!1,c=!1;D.current&&(a=D.current.getVideoTracks().lengh>0,c=D.current.getAudioTracks().lengh>0),o={command:"publish",streamId:e,token:n,subscriberId:void 0!==typeof t?t:"",subscriberCode:void 0!==typeof r?r:"",video:a,audio:c}}U.ws&&U.ws.sendJson(o)}),[]),ee=e.useCallback((function(e,n){var t={command:"joinRoom",room:e,streamId:n};g(e),U.ws&&U.ws.sendJson(t)}),[]),ne=e.useCallback((function(e){var n={command:"leaveFromRoom",room:e};g(e),U.ws&&U.ws.sendJson(n)}),[]),te=e.useCallback((function(e){U.ws&&U.ws.sendJson({command:"join",streamId:e})}),[]),re=e.useCallback((function(e){U.ws&&U.ws.sendJson({command:"leave",streamId:e})}),[]),oe=e.useCallback((function(e,n,t){_.push(e);var r={command:"play",streamId:e,token:n,room:t};n&&(r.token=n),U.ws&&U.ws.sendJson(r),j(!0)}),[]),ae=e.useCallback((function(e){U.ws&&U.ws.sendJson({command:"stop",streamId:e}),j(!1)}),[]),ce=e.useCallback((function(){if(D.current){var e=D.current.getAudioTracks()[0];e.enabled=!e.enabled,C(!e.enabled)}else l&&l("NoActiveConnection")}),[]),ie=e.useCallback((function(){if(D.current){var e=D.current.getVideoTracks()[0];e.enabled=!e.enabled,P(!e.enabled)}else l&&l("NoActiveConnection")}),[]),se=e.useCallback((function(e){U.ws&&U.ws.sendJson({command:"getStreamInfo",streamId:e})}),[]),ue=e.useCallback((function(e,n){try{var t=c((function(){return b&&console.debug("addIceCandidate "+e),Promise.resolve(x[e].addIceCandidate(n)).then((function(){}))}),(function(){}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}),[]),le=e.useCallback((function(e,t,i){try{var s=e,u=i,d=t,f="offer"===u,h="publish";return f&&(h="play"),Promise.resolve(K(s,h)).then((function(){var e=c((function(){return Promise.resolve(x[s].setRemoteDescription(new n.RTCSessionDescription({sdp:d,type:u}))).then((function(e){function n(){V[s]=[];var e=function(){if(f)return Promise.resolve(x[s].createAnswer(m)).then((function(e){return Promise.resolve(X(e,s)).then((function(){}))}))}();if(e&&e.then)return e.then((function(){}))}N[s]=!0;var t=Object.keys(V[s]).length,c=0,i=function(e,n,t){for(var c;;){var i=e();if(a(i)&&(i=i.v),!i)return s;if(i.then){c=0;break}var s=t();if(s&&s.then){if(!a(s)){c=1;break}s=s.s}if(n){var u=n();if(u&&u.then&&!a(u)){c=2;break}}}var l=new r,d=o.bind(null,l,2);return(0===c?i.then(m):1===c?s.then(f):u.then(h)).then(void 0,d),l;function f(r){s=r;do{if(n&&(u=n())&&u.then&&!a(u))return void u.then(h).then(void 0,d);if(!(i=e())||a(i)&&!i.v)return void o(l,1,s);if(i.then)return void i.then(m).then(void 0,d);a(s=t())&&(s=s.v)}while(!s||!s.then);s.then(f).then(void 0,d)}function m(e){e?(s=t())&&s.then?s.then(f).then(void 0,d):f(s):o(l,1,s)}function h(){(i=e())?i.then?i.then(m).then(void 0,d):m(i):o(l,1,s)}}((function(){return c<t}),(function(){return c++}),(function(){return Promise.resolve(ue(s,V[s][c])).then((function(){}))}));return i&&i.then?i.then(n):n()}))}),(function(e){(e.toString().indexOf("InvalidAccessError")>-1||e.toString().indexOf("setRemoteDescription")>-1)&&l&&l("notSetRemoteDescription")}));if(e&&e.then)return e.then((function(){}))}))}catch(e){return Promise.reject(e)}}),[]),de=e.useCallback((function(e,t,r,o){try{var a=e,c=new n.RTCIceCandidate({sdpMLineIndex:t,candidate:r,sdpMid:o});return Promise.resolve(K(a,"peer")).then((function(){var e=function(){if(!0===N[a])return Promise.resolve(ue(a,c)).then((function(){}));if(b&&console.debug("Ice candidate is added to list because remote description is not set yet"),-1===V[a].findIndex((function(e){return JSON.stringify(e)===JSON.stringify(c)}))){var e=Object.keys(c);for(var n in e)void 0!==c[n]&&""!==c[n]||(c[n]=null);V[a].push(c)}}();if(e&&e.then)return e.then((function(){}))}))}catch(e){return Promise.reject(e)}}),[]),fe=e.useCallback((function(e,n,t){U.ws&&U.ws.sendJson({command:"peerMessageCommand",streamId:e,definition:n,data:t})}),[]),me=e.useCallback((function(e,n){x[e].dataChannel.send(n)}),[]),he=e.useCallback((function(e){return null!=x[e]?x[e].signalingState:null}),[]),ve=e.useCallback((function(){try{var e=function(){if(!R&&void 0!==f&&null==D.current&&!p)return Promise.resolve(Z(f)).then((function(){}))}();return Promise.resolve(e&&e.then?e.then((function(){})):void 0)}catch(e){return Promise.reject(e)}}),[R,Z,f]);return e.useEffect((function(){var e=new WebSocket(s),n=-1;return e.onopen=function(t){e.sendJson=function(n){e.send(JSON.stringify(n))},n=setInterval((function(){e.sendJson({command:"ping"})})),ve().then((function(){u&&u(t),U.ws=e,M(!0)})).catch((function(e){l&&l("initError",e)}))},e.onmessage=function(e){try{var n=JSON.parse(e.data);switch(n.command){case"start":Y(n.streamId);break;case"takeCandidate":de(n.streamId,n.label,n.candidate,n.id);break;case"takeConfiguration":le(n.streamId,n.sdp,n.type);break;case"stop":B(n.streamId);break;case"error":l&&l(n.definition,n);break;case"notification":q.current&&d.call(q.current,n.definition,n),"play_finished"!==n.definition&&"publish_finished"!==n.definition||B(n.streamId);break;case"streamInformation":q.current&&d.call(q.current,n.command,n);break;case"pong":q.current&&d.call(q.current,n.command)}return Promise.resolve()}catch(e){return Promise.reject(e)}},e.onerror=function(e){M(!1),clearInterval(n),l&&l("Error on connect",e)},e.onclose=function(){M(!1),clearInterval(n)},function(){e.onopen=null,e.onmessage=null,e.onerror=null,e.onclose=null,clearInterval(n),M(!1)}}),[s]),e.useEffect((function(){q.current={publish:$,joinRoom:ee,leaveFromRoom:ne,join:te,leave:re,play:oe,stop:ae,localStream:D,remoteStreams:L,getUserMedia:Z,getStreamInfo:se,signallingState:he,initPeerConnection:K,handleTurnVolume:ce,handleTurnCamera:ie,isTurnedOf:I,isMuted:y,peerMessage:fe,sendData:me}}),[E]),E?{publish:$,joinRoom:ee,leaveFromRoom:ne,join:te,leave:re,play:oe,stop:ae,localStream:D,remoteStreams:L,getUserMedia:Z,getStreamInfo:se,signallingState:he,initPeerConnection:K,handleTurnVolume:ce,handleTurnCamera:ie,isTurnedOf:I,isMuted:y,peerMessage:fe,sendData:me}:null};
//# sourceMappingURL=rn-antmedia.cjs.production.min.js.map
